# Configuration de la BDD

----

## Properties pour la BDD

ajout de properties dans le fichier **application.properties** dans **src/main/resources**

```properties
# active la console H2 à l'URL http://localhost:8080/h2-console
spring.h2.console.enabled=true
# permet de fixer l'URL de la BDD pour ne pas en générer une aléatoire à chaque démarrage
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.username=sa
# désactiver la création automatique des tables par Hibernate et utiliser les requêtes de schema.sql
spring.jpa.hibernate.ddl-auto=none
# permet de préciser le schéma par défaut en base sur lesquels les objets Java seront mappés
spring.jpa.properties.hibernate.default_schema=formation
```

----

## Properties pour la BDD (Alternative PostGre)

 dans le **pom.xml**, remplacer la dépendence Maven *h2* par *postgresql* :
```xml
<dependency>
	<groupId>org.postgresql</groupId>
	<artifactId>postgresql</artifactId>
	<scope>runtime</scope>
</dependency>
```

remplacer le fichier de **properties** par celui-là:

```properties
spring.datasource.driver-class-name=org.postgresql.Driver
spring.datasource.url=jdbc:postgresql://dvtoucanldb01.ad.insee.intra:1983/di_pg_toucan_dv01
spring.datasource.username=***
spring.datasource.password=***

# désactive les échanges de métadata avec la base postgre (à faire uniquement pour les bases postgre) qui ralentissent le démarrage du serveur
spring.jpa.properties.hibernate.temp.use_jdbc_metadata_defaults=false
# permet de préciser à Hibernate le dialecte à utiliser
# important de le préciser quand on a désactivé la récupération des métadonnées car cela permettait à Hibernate de savoir quel dialecte utiliser
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQL95Dialect
```

----

## Création de données en base

créer un fichier **schema.sql** et un fichier  **data.sql** dans src/main/resources pour initialiser la base :

```sql
-- fichier schema.sql
CREATE SCHEMA formation;

CREATE TABLE formation.VIN (
	id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	chateau VARCHAR(100) NOT NULL,
	appellation VARCHAR(100),
	prix DECIMAL(10,2));

CREATE SEQUENCE formation.vin_id_seq start with 1 increment 1;
```

```sql
-- fichier data.sql
INSERT INTO formation.vin (id, chateau, appellation, prix) VALUES (nextval('formation.vin_id_seq'), 'Château Margaux', 'Margaux', 500);
INSERT INTO formation.vin (id, chateau, appellation, prix) VALUES (nextval('formation.vin_id_seq'), 'Château Cantemerle', 'Haut-Médoc', 30.5);
INSERT INTO formation.vin (id, chateau, appellation, prix) VALUES (nextval('formation.vin_id_seq'), 'Château Lascombes', 'Margaux', 80);
INSERT INTO formation.vin (id, chateau, appellation, prix) VALUES (nextval('formation.vin_id_seq'), 'Domaine Lejeune', 'Pommard', 40);
```

----

## Création de l'objet Java correspondant

```java
package fr.insee.formationapirest.model;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.SequenceGenerator;
import javax.persistence.Table;

@Entity
@Table(name = "vin") // possibilité de surcharger le schéma par défaut : @Table(name = "vin", schema="nomSchema")
public class Vin {
	
	@Id
	@GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "seq_vin")
	@SequenceGenerator(name = "seq_vin", sequenceName = "formation.vin_id_seq", allocationSize = 1)
	private Integer id;
	
	private String chateau;
	private String appellation;
	private Double prix;

    // ajouter les getters et setters	
}
```

----

## Création du DAO

- JpaRepository est une interface de Spring utilisant Hibernate qui donne accès à plein de méthodes nativement
- en implémentant l'interface, il faut préciser le type d'objet correspondant ainsi que le type de la clé primaire

```java
package fr.insee.formationapirest.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import fr.insee.formationapirest.model.Vin;

@Repository
public interface VinRepository extends JpaRepository<Vin, Integer> {
	
}
```
